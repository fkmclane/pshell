#!/bin/sh
if [ "$HOSTNAME" == "login001.palmetto.clemson.edu" ]; then
	if [ -n "$1" ]; then
		args="$@"
	else
		args="-l walltime=4:00:00"
	fi

	jobid="$(echo "$(qsub $args -o /dev/null -j oe "$@" -- "$HOME"/.local/bin/pshell "$DISPLAY")" | cut -d. -f1)"
	echo "Job ID: $jobid"

	while [ ! -f "$HOME"/.cache/pshell/"$jobid" ]; do
		sleep 1
		touch "$HOME"/.cache/pshell/
	done

	exec tmux new-session -s "$jobid" ssh -o StrictHostKeyChecking=no -t "$(<"$HOME"/.cache/pshell/"$jobid")" bash --rcfile "$HOME"/.cache/pshell/"$jobid".env
else
	jobid="$(echo "$PBS_JOBID" | cut -d. -f1)"

	mkdir -p "$HOME"/.cache/pshell
	echo "$HOSTNAME" >"$HOME"/.cache/pshell/"$jobid"
	echo "source /etc/profile" >"$HOME"/.cache/pshell/"$jobid".env
	env | sed 's/^/export /' >>"$HOME"/.cache/pshell/"$jobid".env
	echo "source \"$HOME\"/.bash_profile" >>"$HOME"/.cache/pshell/"$jobid".env

	trap "rm \"$HOME\"/.cache/pshell/\"$jobid\"{,.env}" TERM

	exec sleep infinity
fi
