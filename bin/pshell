#!/bin/sh
if [ "$HOSTNAME" == "login001.palmetto.clemson.edu" ]; then
	if [ -n "$1" ]; then
		args="$@"
	else
		args="-l walltime=4:00:00"
	fi

	jobid="$(echo "$(qsub $args -o /dev/null -j oe "$@" -- "$HOME"/.local/bin/pshell "$DISPLAY")" | cut -d. -f1)"
	echo "Job ID: $jobid"

	while [ ! -f "$HOME"/.cache/pshell/"$jobid" ]; do
		sleep 1
	done

	exec tmux new-session -s "$jobid" ssh -o StrictHostKeyChecking=no "$(<"$HOME"/.cache/pshell/"$jobid")"
else
	jobid="$(echo "$PBS_JOBID" | cut -d. -f1)"

	mkdir -p "$HOME"/.cache/pshell
	echo "$HOSTNAME" >"$HOME"/.cache/pshell/"$jobid"

	trap "rm \"$HOME\"/.cache/pshell/\"$jobid\"" TERM

	exec sleep infinity
fi
